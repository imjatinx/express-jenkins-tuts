name: Express CD Pipeline (Industry Blue/Green)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        run: |
          docker login ghcr.io -u "${{ github.actor }}" --password-stdin <<< "${{ secrets.GHCR_TOKEN }}"

      - name: Build Docker image
        run: |
          docker build -t ghcr.io/${{ github.repository_owner }}/express-app:${{ github.sha }} .

      - name: Push Docker image
        run: |
          docker push ghcr.io/${{ github.repository_owner }}/express-app:${{ github.sha }}

      - name: Deploy to Server (Industry Blue/Green)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            IMAGE="ghcr.io/${{ github.repository_owner }}/express-app:${{ github.sha }}"
            NGINX_UPSTREAM_CONF="/etc/nginx/conf.d/app_backend.conf"

            echo "Login to GHCR"
            docker login ghcr.io -u "${{ github.repository_owner }}" --password-stdin <<< "${{ secrets.GHCR_TOKEN }}"

            echo "Pull image"
            docker pull $IMAGE

            echo "Cleanup any existing GREEN"
            docker ps -aq --filter "name=^express-green$" | xargs -r docker rm -f

            echo "Start GREEN on random free port"
            docker run -d \
              --name express-green \
              -p 127.0.0.1::5000 \
              -e PORT=5000 \
              -e NODE_ENV=production \
              -e APP_NAME="CI-CD Express" \
              $IMAGE

            echo "Discover GREEN port"
            GREEN_PORT=$(docker inspect \
              -f '{{ (index (index .NetworkSettings.Ports "5000/tcp") 0).HostPort }}' \
              express-green)

            echo "GREEN is running on port $GREEN_PORT"

            echo "Wait for app to boot"
            sleep 5

            echo "Health check GREEN"
            if curl -fs http://127.0.0.1:$GREEN_PORT/health; then
              echo "GREEN healthy — switching traffic"

              sudo tee $NGINX_UPSTREAM_CONF <<EOF
              upstream app_backend {
                server 127.0.0.1:$GREEN_PORT;
              }
              EOF

              sudo nginx -t
              sudo nginx -s reload

              echo "Remove old BLUE"
              docker rm -f express-blue || true

              echo "Promote GREEN → BLUE"
              docker rename express-green express-blue

              echo "Deployment successful (zero downtime)"
            else
              echo "GREEN unhealthy — AUTO ROLLBACK"

              docker rm -f express-green
              exit 1
            fi
